---
import InputField from "./InputField.astro";
import { Icon } from "astro-icon/components";
---

<section>
  <!-- ==========================
       Kontaktformular
       ========================== -->
  <form
    id="contactForm"
    name="contact"
    method="POST"
    action="."
    netlify-honeypot="bot-field"
    data-netlify="true"
    class="grid grid-cols-2 gap-8 prose mx-auto p-4"
  >
    <!-- Hidden Fields für Netlify -->
    <input type="hidden" name="form-name" value="contact" />
    <input type="hidden" name="bot-field" />

    <!-- Vorname -->
    <InputField
      id="Vorname"
      label="Vorname"
      type="text"
      placeholder="Ihr Vorname"
      class="col-span-2 sm:col-span-1"
    />

    <!-- Nachname -->
    <InputField
      id="Nachname"
      label="Nachname"
      type="text"
      placeholder="Ihr Nachname"
      class="col-span-2 sm:col-span-1"
    />

    <!-- E-Mail -->
    <InputField
      id="email"
      label="E-Mail"
      type="email"
      placeholder="Ihre E-Mail Adresse"
      class="col-span-2 sm:col-span-1"
    />

    <!-- Telefon -->
    <InputField
      id="phone"
      label="Telefon"
      type="tel"
      placeholder="Ihre Telefonnummer"
      class="col-span-2 sm:col-span-1"
    />

    <!-- Nachricht -->
    <div class="group col-span-2 flex flex-wrap">
      <label
        class="w-30 font-smallCaps border border-brand border-b-0 tracking-wider text-brand group-focus-within:text-white group-focus-within:bg-brand p-2 transition-all"
        for="Nachricht"
      >
        Nachricht
      </label>
      <textarea
        id="message"
        name="Nachricht"
        cols="30"
        rows="10"
        placeholder="Ihre Nachricht an uns"
        class="w-full border border-1 border-brand p-2 outline-none"
      ></textarea>
    </div>

    <!-- Submit Button -->
    <div class="col-span-2 flex justify-end">
      <input
        id="contact-submit"
        type="submit"
        value="Senden"
        class="bg-brand text-white px-8 py-2 hover:underline transition-all hover:scale-105 hover:shadow-lg hover:underline-offset-4 font-smallCaps tracking-wider text-lg"
      />
    </div>
  </form>

  <!-- ==========================
       Erfolgsmeldung
       ========================== -->
  <div id="message-success" class="hidden prose text-center m-auto">
    <div
      class="text-white bg-brand m-auto rounded-full w-32 h-32 flex justify-center items-center"
    >
      <Icon name="icon-mail" class="w-16 h-16" />
    </div>
    <p>
      Vielen Dank für Ihre Nachricht! <br />
      Wir werden uns so schnell wie möglich bei Ihnen melden.
    </p>
  </div>

  <!-- ==========================
       Fehlermeldung
       ========================== -->
  <div id="message-error" class="hidden prose text-center m-auto">
    <p>
      Leider ist ein Fehler aufgetreten! <br />
      Bitte laden Sie die Seite neu und versuchen es noch ein Mal.
    </p>
  </div>
</section>

<!-- ==========================
     Client-Script für AJAX-Submit (JavaScript)
     ========================== -->
<script is:client>
  document.addEventListener("DOMContentLoaded", function() {
    // Formular abrufen
    const contactForm = document.getElementById("contactForm");
    if (!contactForm) return;

    // Erfolg- und Fehlermeldungen abrufen
    const successMessage = document.getElementById("message-success");
    const errorMessage = document.getElementById("message-error");

    // Debug-Ausgabe
    // console.log("FORM:", contactForm);
    // console.log("INSTANCE:", contactForm instanceof HTMLFormElement);

    // Eventlistener für Submit
    contactForm.addEventListener("submit", function(event) {
      event.preventDefault(); // Verhindert Seitenreload
      event.stopPropagation();

      const formData = new FormData(contactForm);
      let valid = true;

      // Alle Input- und Textarea-Felder überprüfen
      const fields = contactForm.querySelectorAll("input, textarea");

      fields.forEach(function(field) {
        // Vorherige Fehlermeldungen entfernen
        field.classList.remove("border-red-500");
        if (field.nextElementSibling && field.nextElementSibling.classList.contains("text-red-600")) {
          field.nextElementSibling.remove();
        }

        // Validierung
        if (!field.checkValidity()) {
          valid = false;
          field.classList.add("border-red-500");

          const msg = document.createElement("div");
          msg.className = "text-red-600 text-sm mt-1";
          msg.textContent = field.validationMessage;
          field.insertAdjacentElement("afterend", msg);
        }
      });

      // Wenn Validierung fehlschlägt, Abbruch
      if (!valid) return;

      // AJAX-Request an Netlify Forms
      fetch("/", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams(formData).toString()
      })
      .then(function(response) {
        if (response.ok) {
          contactForm.classList.add("hidden");
          successMessage.classList.remove("hidden");
        } else {
          throw new Error("Network response was not ok");
        }
      })
      .catch(function(error) {
        console.error("Error:", error);
        contactForm.classList.add("hidden");
        errorMessage.classList.remove("hidden");
      });
    });
  });
</script>
