---
import InputField from "./InputField.astro";
import { Icon } from "astro-icon/components";
---

<section>
  <!-- Formular: Wird bei Erfolg oder Fehler ausgeblendet -->
  <form
    id="form"
    class="grid grid-cols-2 gap-8 prose mx-auto p-4"
    name="contact"
    method="POST"
    netlify-honeypot="bot-field"
    data-netlify="true"
  >
    <!-- Hidden fields für Netlify Forms -->
    <input type="hidden" name="form-name" value="contact" />
    <input type="hidden" name="bot-field" />
    <InputField
      id="Vorname"
      label="Vorname"
      type="text"
      placeholder="Ihr Vorname"
      class="col-span-2 sm:col-span-1"
    />
    <InputField
      id="Nachname"
      label="Nachname"
      type="text"
      placeholder="Ihr Nachname"
      class="col-span-2 sm:col-span-1"
    />

    <!-- E-Mail -->
    <InputField
      id="email"
      label="E-Mail"
      type="email"
      placeholder="Ihre E-Mail Adresse"
      class="col-span-2 sm:col-span-1"
    />

    <!-- Telefon -->
    <InputField
      id="phone"
      label="Telefon"
      type="tel"
      placeholder="Ihre Telefonnummer"
      class="col-span-2 sm:col-span-1"
    />

    <div class="group col-span-2 flex flex-wrap">
      <label
        class="w-30 font-smallCaps border border-brand border-b-0 tracking-wider text-brand group-focus-within:text-white group-focus-within:bg-brand p-2 transition-all"
        for="Nachricht"
      >
        Nachricht
      </label>
      <textarea
        id="message"
        name="Nachricht"
        cols="30"
        rows="10"
        placeholder="Ihre Nachricht an uns"
        class="w-full border border-1 border-brand p-2 outline-none"></textarea>
    </div>

    <div class="col-span-2 flex justify-end">
      <input
        id="contact-submit"
        type="submit"
        value="Senden"
        class="bg-brand text-white px-8 py-2 hover:underline transition-all hover:scale-105 hover:shadow-lg hover:underline-offset-4 font-smallCaps tracking-wider text-lg"
      />
    </div>
  </form>

  <!-- Erfolgsmeldung: Zunächst versteckt -->
  <div id="message-success" class="hidden prose text-center m-auto">
    <div
      class="text-white bg-brand m-auto rounded-full w-32 h-32 flex justify-center items-center"
    >
      <Icon name="icon-mail" class="w-16 h-16" />
    </div>
    <p>
      Vielen Dank für Ihre Nachricht! <br />
      Wir werden uns so schnell wie möglich bei Ihnen melden.
    </p>
  </div>

  <!-- Fehlermeldung: Zunächst versteckt -->
  <div id="message-error" class="hidden prose text-center m-auto">
    <p>
      Leider ist ein Fehler aufgetreten! <br />
      Bitte laden Sie die Seite neu und versuchen es noch ein Mal.
    </p>
  </div>
</section>

<script lang="ts">
  const form = document.querySelector<HTMLFormElement>("form");
  const successMessage = document.getElementById("message-success");
  const errorMessage = document.getElementById("message-error");

  form?.addEventListener("submit", async (event) => {
    // Verhindert das Standard-Formular-Submit und Seitenneuladen
    event.preventDefault();
    event.stopPropagation();

    const formData = new FormData(form);
    let valid = true;

    // Validierung: Prüft alle Eingabefelder auf Gültigkeit
    form
      .querySelectorAll<
        HTMLInputElement | HTMLTextAreaElement
      >("input, textarea")
      .forEach((field) => {
        // Entfernt vorherige Fehlermeldungen
        field.classList.remove("border-red-500");
        field.nextElementSibling?.remove();

        // Prüft ob das Feld gültig ist
        if (!field.checkValidity()) {
          valid = false;
          field.classList.add("border-red-500");
          const msg = document.createElement("div");
          msg.className = "text-red-600 text-sm mt-1";
          msg.textContent = field.validationMessage;
          field.insertAdjacentElement("afterend", msg);
        }
      });

    // Stoppt den Versand wenn Validierung fehlschlägt
    if (!valid) return;

    // Sendet das Formular per AJAX an Netlify (verhindert Seitenneuladen)

    // fetch("/", {
    //   method: "POST",
    //   headers: { "Content-Type": "application/x-www-form-urlencoded" },
    //   body: new URLSearchParams(formData as any).toString(),
    // })
    //   .then(() => {
    //     // Bei Erfolg: Formular ausblenden, Erfolgsmeldung einblenden
    //     form.classList.add("hidden");
    //     successMessage?.classList.remove("hidden");
    //   })
    //   .catch((error) => {
    //     // Bei Fehler: Formular ausblenden, Fehlermeldung einblenden
    //     console.error("Fehler beim Senden:", error);
    //     form.classList.add("hidden");
    //     errorMessage?.classList.remove("hidden");
    //   });

    try {
      const response = await fetch("/", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams(formData as any).toString(),
      });

      if (response.ok) {
        form.classList.add("hidden");
        document.getElementById("message-success")?.classList.remove("hidden");
      } else {
        throw new Error("Network response was not ok");
      }
    } catch (error) {
      console.error("Error:", error);
      form.classList.add("hidden");
      document.getElementById("message-error")?.classList.remove("hidden");
    }
  });
</script>
